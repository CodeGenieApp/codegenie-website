---
title: Database
description: A walkthrough of the Database
---

import FileTree from '../../../../../components/file-tree.astro'

Code Genie projects include an infinitely scalable Serverless Database using [AWS DynamoDB](https://aws.amazon.com/dynamodb). A Table is created for each Entity defined in your [App Definition](../app-definition), along with code to make querying and updating data easy for the [REST API](./api), [Cognito Triggers](./authentication-identity#triggers), and other services.

## Project Structure

<FileTree>
- packages
  - api
    - controllers
      - user.ts
      - widget.ts
    - models
      - User.ts
      - Widget.ts
    - utils
      dynamodb.ts
  - cdk # see the [Cloud Infrastructure](./cloud-infrastructure#database) guide for more details
    - lib
      - constructs
        - tables
          - WidgetTable.ts one table per entity
          - UserTable.ts
        - BaseTable.ts
</FileTree>

## Entity Models and Controllers

[DynamoDB Toolbox](https://github.com/jeremydaly/dynamodb-toolbox) Models and Controllers are created for each Entity defined in your [App Definition](../app-definition).

The following information from the Entity is used to construct the DynamoDB Toolbox [Table](https://github.com/jeremydaly/dynamodb-toolbox) and [Entity](https://github.com/jeremydaly/dynamodb-toolbox):

- `Table.name` &ndash; An environment variable named `WIDGET_TABLE` must be set to the name of the DynamoDB Table (autogenerated by CDK).
- `Table.partitionKey` and `Table.sortKey` &ndash; Defined in `x-codeGenie.dynamodb.partitionKey` and `x-codeGenie.dynamodb.sortKey`.
- `Table.indexes` &ndash; Defined in `x-codeGenie.dynamodb.globalSecondaryIndexes`.
- `Entity.name` &dash; The Entity name.
- `Entity.attributes` &ndash; Entity properties and their types (converted to a DynamoDB equivalent).

The controller includes CRUD methods that are primarily used by the REST API, as well as some [Cognito Triggers](./auth-identity#triggers). The methods include:

- `list*` &ndash; Returns a list of records
- `get*` &ndash; Returns a single record
- `create*` &ndash; Creates a record with a unique ID.
- `update*` &ndash; Updates a record (if it exists) and returns the record with the new data.
- `delete*` &ndash; Deletes a record (if it exists).

### User Controller

The User Controller includes the additional following methods:

- `getCurrentUser` &ndash; Calls the `getUser` method with the [`req.cognitoUser.userId`](.backend/api#authidentity-handler) (derived from access token).
- `getCurrentUserEmail` &ndash; Returns [`req.cognitoUser.email`](.backend/api#authidentity-handler) (derived from access token).

## dynamodb.ts
Helper methods

### dynamoDbDocumentClient

This [dynamodb client]() is used by the Models described above.

When no `AWS_ACCESS_KEY_ID` or `AWS_SECRET_ACCESS_KEY` environment variables exist, it's assumed we're trying to run in local development mode and attempts to use the [`_dev` profile defined in `~/.aws/credentials`](../../guides/deployments#setup-aws-cli-credentials-profiles).

### dynamoCreateItem(\{ entity, attributes })

DynamoDB doesn't have a `create` method, and you must rely on the `put` method which doesn't care if the item already exists and will overwrite any existing value. DynamoDB Toolbox also doesn't provide a `create` convenience method. To ensure we don't accidentally overwrite an existing item, this method uses the `put` method with a condition that the item doesn't already exist (causing DynamoDB to throw an error if it does).

### scanAll(\{ entity, scanOptions, maxPages = Infinity, maxItems = Infinity, filter })

Performs an exhaustive scan of a DynamoDB table. Can be limited by a defined maximum number of pages (`maxPages`) or until a maximum number of items (`maxItems`) have been found that match the `filter` (optional).

This method is especially helpful 

:::caution
It's not advised to call this method on a large table without specifying `maxPages` or `maxItems`.
:::